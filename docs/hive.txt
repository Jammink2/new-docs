# Hive (SQL-style) Query Language

[Treasure Data](http://treasure-data.com/) is a Hadoop-based cloud data warehousing, which provides a SQL-like query language interface called Hive query language. This article covers the basics of the Hive query language.

## Prerequisites

  * Basic knowledge of Treasure Data, including [the toolbelt](http://toolbelt.treasure-data.com).

## About Apache Hive

The Hive query language (HiveQL) is the primary data processing method for Treasure Data. HiveQL is powered by [Apache Hive](http://hive.apache.org/).

NOTE: Users can only issue "SELECT" statements. All other types of statements (ex: Data Definition Statements, Data Manipulation Statements, etc.) are not currently available.

## Official Documents 

* [The official Hive tutorial](https://cwiki.apache.org/confluence/display/Hive/Tutorial) goes offer the basics of HiveQL.
* [The official Hive language manual](https://cwiki.apache.org/confluence/display/Hive/LanguageManual) covers all features of HiveQL.

## CLI Usage

You can submit the query by `td query` command.

    :::term
    usage:
      $ td query <sql>
    
    example:
      $ td query -d example_db -w -r rset1 "select count(*) from table1"
    
    description:
      Issue a query
    
    options:
      -d, --database DB_NAME           use the database (required)
      -w, --wait                       wait for finishing the job
      -o, --output PATH                write result to the file
      -f, --format FORMAT              format of the result to write to the file (tsv, csv, json or msgpack)
      -r, --result RESULT_URL          write result to the URL (see also result:create subcommand)
      -u, --user NAME                  set user name for the result URL
      -p, --password                   ask password for the result URL
      -P, --priority PRIORITY          set priority

An example query is like this.

    $ td query -w -d testdb \
      "SELECT v['code'], COUNT(1) FROM www_access GROUP BY v['code']"

## Example Queries

Here are a couple of basic examples. The underlying table consiste of three fields: `ip`, `url`, and `time`.

#### Number of Records

    :::sql
    SELECT COUNT(1) FROM www_access;

#### Number of Unique IPs

    :::sql
    SELECT COUNT(distinct v['ip']) FROM www_access;

#### Number of Unique IPs that Accessed the Top Page

    :::sql
    SELECT COUNT(distinct v['ip']) FROM www_access \
      WHERE v['url']='/';

#### Number of Accesses per Unique IP

    :::sql
    SELECT v['ip'], COUNT(1) FROM www_access \
      GROUP BY v['ip'] LIMIT 30;

#### Unique IPs Sorted by Number of Accesses

    :::sql
    SELECT v['ip'], COUNT(1) AS cnt FROM www_access \
      GROUP BY v['ip']
      ORDER BY cnt DESC LIMIT 30;

#### Number of Accesses After a Certain Time

    :::sql
    SELECT COUNT(1) FROM www_access \
      WHERE time >= unix_timestamp('2011-08-19 00:00:00');

NOTE: The `time` column is a special column that is always present and stores the UNIX timestamp of the log.

#### Number of Accesses Each Day

    :::sql
    SELECT from_unixtime(CAST(time/(60*60*24) AS INT)*60*60*24) AS day, \
      COUNT(1) FROM www_access \
      GROUP BY CAST(time/(60*60*24) AS INT);
